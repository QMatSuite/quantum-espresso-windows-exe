name: Publish mirrored QE binaries (verified + attested)

on:
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream release tag in QMatSuite/qmatsuite-toolchain"
        required: true
        default: "qe-7.5-win-oneapi-msmpi-20251223-d409e9b"
      asset_zip:
        description: "Upstream zip asset filename"
        required: true
        default: "qe-7.5-win-oneapi-msmpi.zip"
      asset_checksums:
        description: "Upstream checksums filename"
        required: true
        default: "checksums.txt"
      publish_tag:
        description: "Portal repo tag to create/update"
        required: true
        default: "qe-7.5-win-oneapi-msmpi"
      publish_name:
        description: "Portal repo release name"
        required: true
        default: "Quantum ESPRESSO 7.5 — Windows (oneAPI + MS-MPI)"
      prerelease:
        description: "Mark as prerelease?"
        required: true
        type: boolean
        default: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # create/update release + upload assets
      id-token: write          # required for Sigstore OIDC flow
      attestations: write      # required to persist the attestation on GitHub
    steps:
      - name: Prepare workspace
        run: |
          mkdir -p out

      - name: Download assets from upstream release
        env:
          UPSTREAM_REPO: QMatSuite/qmatsuite-toolchain
          UPSTREAM_TAG: ${{ inputs.upstream_tag }}
          ZIP_NAME: ${{ inputs.asset_zip }}
          SUM_NAME: ${{ inputs.asset_checksums }}
        run: |
          set -euo pipefail
          base="https://github.com/${UPSTREAM_REPO}/releases/download/${UPSTREAM_TAG}"
          echo "Downloading: ${base}/${ZIP_NAME}"
          curl -L --fail -o "out/${ZIP_NAME}" "${base}/${ZIP_NAME}"
          echo "Downloading: ${base}/${SUM_NAME}"
          curl -L --fail -o "out/${SUM_NAME}" "${base}/${SUM_NAME}"
          ls -lah out

      - name: Verify SHA256 against checksums.txt (case-insensitive)
        id: verify
        env:
          ZIP_NAME: ${{ inputs.asset_zip }}
          SUM_NAME: ${{ inputs.asset_checksums }}
        run: |
          set -euo pipefail
          cd out

          # Expected hash: first field on the line containing the zip filename.
          expected="$(grep -E "([A-Fa-f0-9]{64})[[:space:]]+${ZIP_NAME}$" "${SUM_NAME}" | awk '{print $1}' | head -n1)"
          if [ -z "${expected}" ]; then
            echo "ERROR: Could not find ${ZIP_NAME} in ${SUM_NAME}"
            exit 1
          fi

          actual="$(sha256sum "${ZIP_NAME}" | awk '{print $1}')"

          # normalize to uppercase to avoid your previous mismatch
          expected_u="$(echo "${expected}" | tr '[:lower:]' '[:upper:]')"
          actual_u="$(echo "${actual}" | tr '[:lower:]' '[:upper:]')"

          echo "Expected: ${expected_u}"
          echo "Actual:   ${actual_u}"

          if [ "${expected_u}" != "${actual_u}" ]; then
            echo "ERROR: SHA256 mismatch. Refusing to publish."
            exit 1
          fi

          echo "ZIP_ABS_PATH=$(python3 -c 'import os; print(os.path.abspath("'"${ZIP_NAME}"'"))')" >> "$GITHUB_OUTPUT"
          echo "SHA256=${actual_u}" >> "$GITHUB_OUTPUT"
          echo "Verified OK."

      - name: Attest mirroring provenance (portal repo)
        id: attest
        uses: actions/attest-build-provenance@v3
        with:
          # Use absolute path (avoids “not rooted” problems)
          subject-path: ${{ steps.verify.outputs.ZIP_ABS_PATH }}
          show-summary: true

      - name: Create/Update GitHub Release in portal repo (upload verified assets)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.publish_tag }}
          name: ${{ inputs.publish_name }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: |
            out/${{ inputs.asset_zip }}
            out/${{ inputs.asset_checksums }}
          body: |
            This release mirrors a prebuilt Quantum ESPRESSO Windows package from **QMatSuite/qmatsuite-toolchain**.

            **Upstream release tag:** `${{ inputs.upstream_tag }}`
            **Upstream asset:** `${{ inputs.asset_zip }}`
            **Verified SHA256:** `${{ steps.verify.outputs.SHA256 }}`

            ✅ This portal workflow **downloads + verifies** the upstream ZIP and then creates an **attestation for the mirrored file** in *this* repository.
            Note: this attestation proves the **mirroring process**, not compilation.

            **Attestation (portal repo):** ${{ steps.attest.outputs.attestation-url }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
